<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yoyi Money Tracker</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --good:#16a34a;
      --bad:#dc2626;
      --btn:#111827;
      --btnText:#ffffff;
      --chip:#f3f4f6;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft YaHei",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:16px 16px 8px;
      position:sticky; top:0;
      background:linear-gradient(to bottom, rgba(246,247,251,.95), rgba(246,247,251,.75));
      backdrop-filter: blur(8px);
      z-index:2;
    }
    h1{margin:0; font-size:20px; display:flex; align-items:center; gap:8px}
    .sub{color:var(--muted); font-size:12px; margin-top:6px}
    main{padding:12px 16px 28px; max-width:980px; margin:0 auto}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      font-size:12px;
      color:#111;
      border:1px solid var(--line);
    }
    .bal{
      font-size:28px;
      font-weight:800;
      margin-top:10px;
      letter-spacing:.2px;
    }
    .hint{color:var(--muted); font-size:12px; margin-top:4px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 860px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:15px;
      background:#fff;
      outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    button{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-size:15px;
      cursor:pointer;
    }
    .primary{background:var(--btn); color:var(--btnText)}
    .secondary{background:#fff; border:1px solid var(--line); color:var(--text)}
    .danger{background:#fff; border:1px solid #fecaca; color:var(--bad)}
    .small{padding:8px 10px; font-size:13px; border-radius:10px}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
    }
    .msg.good{border-color:#bbf7d0; color:#065f46}
    .msg.bad{border-color:#fecaca; color:#7f1d1d}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th, td{border-bottom:1px solid var(--line); padding:10px 8px; font-size:13px; vertical-align:top}
    th{color:var(--muted); text-align:left; font-weight:600}
    td.right, th.right{text-align:right}
    .tag{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      font-size:12px;
      color:#111;
      white-space:nowrap;
    }
    .amtIn{color:var(--good); font-weight:700}
    .amtOut{color:var(--bad); font-weight:700}
    .footerHint{color:var(--muted); font-size:12px; margin-top:10px}
    .split{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .tag{background:#fff}
  </style>
</head>
<body>
<header>
  <h1>ğŸ§¸ Yoyi çš„å‹å²é’±å°è´¦æœ¬</h1>
  <div class="sub">ä¸‰è´¦æˆ·ï¼šğŸ’°Saveï¼ˆæœªæ¥ï¼‰ğŸWishï¼ˆæ„¿æœ›ï¼‰â¤ï¸Giveï¼ˆå¸®åŠ©ï¼‰ï½œæ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼ˆå»ºè®®å¶å°”å¯¼å‡º CSV å¤‡ä»½ï¼‰</div>
</header>

<main>
  <section class="grid">
    <div class="card">
      <span class="pill">ğŸ’° SAVE å‚¨è“„</span>
      <div class="bal" id="balSave">Â¥0</div>
      <div class="hint">ç»™æœªæ¥çš„ä½ ï¼šåˆä¸­åå†è®¨è®ºæ€ä¹ˆç”¨ä¹Ÿå¯ä»¥</div>
    </div>
    <div class="card">
      <span class="pill">ğŸ WISH æ„¿æœ›</span>
      <div class="bal" id="balWish">Â¥0</div>
      <div class="hint">å¤§æ„¿æœ›/ç¤¼ç‰©ï¼šå¯ä»¥å’Œçˆ¶æ¯ä¸€èµ·å‡º</div>
    </div>
    <div class="card">
      <span class="pill">â¤ï¸ GIVE å¸®åŠ©</span>
      <div class="bal" id="balGive">Â¥0</div>
      <div class="hint">æèµ /å¸®åŠ©ä»–äººï¼šå¯ä»¥çˆ¶æ¯é…æ¯”</div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="split">
      <div style="font-weight:800">âœï¸ æ·»åŠ  / ä¿®æ”¹ ä¸€ç¬”è®°å½•</div>
      <div class="kpi">
        <span class="tag">ğŸ“Œ ç‚¹â€œç¼–è¾‘â€å¯ä»¥ä¿®æ”¹</span>
        <span class="tag">ğŸ§® ä¼šè‡ªåŠ¨ç®—ä½™é¢</span>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div>
        <label>è´¦æˆ·</label>
        <select id="acct">
          <option value="save">ğŸ’° Saveï¼ˆå‚¨è“„ï¼‰</option>
          <option value="wish">ğŸ Wishï¼ˆæ„¿æœ›ï¼‰</option>
          <option value="give">â¤ï¸ Giveï¼ˆå¸®åŠ©ï¼‰</option>
        </select>
      </div>
      <div>
        <label>ç±»å‹</label>
        <select id="type">
          <option value="in">â• å­˜å…¥ï¼ˆ+ï¼‰</option>
          <option value="out">â– æ”¯å‡ºï¼ˆ-ï¼‰</option>
        </select>
      </div>
      <div>
        <label>é‡‘é¢ï¼ˆJPYï¼‰</label>
        <input id="amt" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ 2000" />
      </div>
      <div>
        <label>æ—¥æœŸ</label>
        <input id="date" type="date" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
        <select id="cat">
          <option value="">ï¼ˆä¸é€‰ä¹Ÿå¯ä»¥ï¼‰</option>
          <option value="donation">ğŸ—ï¸ æèµ /å…¬ç›Š</option>
          <option value="gift">ğŸ ç¤¼ç‰©</option>
          <option value="toy">ğŸ§© ç©å…·/ä¹é«˜</option>
          <option value="trip">ğŸ§³ æ—…è¡Œ/æ´»åŠ¨</option>
          <option value="study">ğŸ“š å­¦ä¹ /è®¾å¤‡</option>
          <option value="other">âœ¨ å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input id="note" type="text" placeholder="ä¾‹å¦‚ï¼šå­¦æ ¡ææ¬¾ / ç”Ÿæ—¥ç¤¼ç‰© / ä¹é«˜å‡ºèµ„" />
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="btnSave" onclick="saveTx()">ä¿å­˜è¿™ä¸€ç¬”</button>
      <button class="secondary" onclick="clearForm()">æ¸…ç©ºè¾“å…¥</button>
      <button class="secondary" onclick="exportCSV()">å¯¼å‡ºCSV</button>
      <button class="danger" onclick="resetAll()">æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆè°¨æ…ï¼‰</button>
    </div>

    <div id="msg" class="msg" style="display:none"></div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="split">
      <div style="font-weight:800">ğŸ“’ è®°å½•åˆ—è¡¨ï¼ˆæœ€æ–°åœ¨ä¸Šé¢ï¼‰</div>
      <div class="footerHint">å°æŠ€å·§ï¼šæƒ³æ”¹ä¸€ç¬”ï¼Œç‚¹å³ä¾§â€œç¼–è¾‘â€ã€‚ä¸éœ€è¦é€ç¬”è®°â€œé›¶èŠ±é’±â€ï¼Œè¿™é‡Œåªç®¡å‹å²é’±ä¸‰è´¦æˆ·å³å¯ã€‚</div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="min-width:110px">æ—¥æœŸ</th>
            <th style="min-width:110px">è´¦æˆ·</th>
            <th style="min-width:80px">ç±»å‹</th>
            <th style="min-width:110px">åˆ†ç±»</th>
            <th>å¤‡æ³¨</th>
            <th class="right" style="min-width:110px">é‡‘é¢</th>
            <th class="right" style="min-width:140px">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="txBody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const KEY = "yoyi_money_tracker_v2";

  const acctEl = document.getElementById("acct");
  const typeEl = document.getElementById("type");
  const amtEl  = document.getElementById("amt");
  const dateEl = document.getElementById("date");
  const catEl  = document.getElementById("cat");
  const noteEl = document.getElementById("note");
  const msgEl  = document.getElementById("msg");
  const btnSaveEl = document.getElementById("btnSave");

  let editingId = null;

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function yen(n){
    const sign = n < 0 ? "-" : "";
    const v = Math.abs(Math.round(n));
    return sign + "Â¥" + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function acctName(a){
    if(a==="save") return "ğŸ’° Save";
    if(a==="wish") return "ğŸ Wish";
    return "â¤ï¸ Give";
  }

  function catName(c){
    const map = {
      "donation":"ğŸ—ï¸ æèµ /å…¬ç›Š",
      "gift":"ğŸ ç¤¼ç‰©",
      "toy":"ğŸ§© ç©å…·/ä¹é«˜",
      "trip":"ğŸ§³ æ—…è¡Œ/æ´»åŠ¨",
      "study":"ğŸ“š å­¦ä¹ /è®¾å¤‡",
      "other":"âœ¨ å…¶ä»–",
      "":"â€”"
    };
    return map[c ?? ""] ?? "â€”";
  }

  function showMsg(text, kind=""){
    msgEl.style.display = "block";
    msgEl.className = "msg" + (kind ? (" " + kind) : "");
    msgEl.textContent = text;
    clearTimeout(showMsg._t);
    showMsg._t = setTimeout(()=>{ msgEl.style.display="none"; }, 2600);
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw){
      const init = { tx: [] };
      localStorage.setItem(KEY, JSON.stringify(init));
      return init;
    }
    try { return JSON.parse(raw); }
    catch(e){
      const init = { tx: [] };
      localStorage.setItem(KEY, JSON.stringify(init));
      return init;
    }
  }

  function persist(data){
    localStorage.setItem(KEY, JSON.stringify(data));
  }

  function calcBalances(tx){
    const bal = {save:0,wish:0,give:0};
    tx.forEach(t=>{
      const amt = Number(t.amount)||0;
      const delta = (t.type==="in") ? amt : -amt;
      bal[t.acct] += delta;
    });
    return bal;
  }

  function render(){
    const data = load();
    const bal = calcBalances(data.tx);

    document.getElementById("balSave").textContent = yen(bal.save);
    document.getElementById("balWish").textContent = yen(bal.wish);
    document.getElementById("balGive").textContent = yen(bal.give);

    const tb = document.getElementById("txBody");
    tb.innerHTML = "";

    // newest first
    const list = data.tx.slice().sort((a,b)=>{
      if(a.date !== b.date) return b.date.localeCompare(a.date);
      return (b.createdAt||"").localeCompare(a.createdAt||"");
    });

    list.forEach(t=>{
      const tr = document.createElement("tr");
      const isOut = t.type==="out";
      const amtClass = isOut ? "amtOut" : "amtIn";
      const sign = isOut ? "-" : "+";
      tr.innerHTML = `
        <td>${t.date}</td>
        <td><span class="tag">${acctName(t.acct)}</span></td>
        <td>${isOut ? "â– æ”¯å‡º" : "â• å­˜å…¥"}</td>
        <td><span class="tag">${catName(t.cat)}</span></td>
        <td>${escapeHtml(t.note || "")}</td>
        <td class="right ${amtClass}">${sign}${yen(Number(t.amount)||0).replace("Â¥","Â¥")}</td>
        <td class="right">
          <button class="secondary small" onclick="startEdit('${t.id}')">ç¼–è¾‘</button>
          <button class="danger small" onclick="deleteTx('${t.id}')">åˆ é™¤</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/&/g,"&amp;")
      .replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function getForm(){
    const acct = acctEl.value;
    const type = typeEl.value;
    const amount = Number(amtEl.value);
    const date = dateEl.value || todayISO();
    const cat = catEl.value || "";
    const note = (noteEl.value || "").trim();

    return {acct, type, amount, date, cat, note};
  }

  function clearForm(){
    editingId = null;
    acctEl.value = "save";
    typeEl.value = "in";
    amtEl.value = "";
    dateEl.value = todayISO();
    catEl.value = "";
    noteEl.value = "";
    btnSaveEl.textContent = "ä¿å­˜è¿™ä¸€ç¬”";
    showMsg("å·²æ¸…ç©ºè¾“å…¥", "");
  }

  function saveTx(){
    const data = load();
    const f = getForm();

    if(!f.amount || f.amount <= 0){
      showMsg("è¯·è¾“å…¥å¤§äº 0 çš„é‡‘é¢", "bad");
      return;
    }

    // balance check for OUT
    const bal = calcBalances(data.tx);
    const after = bal[f.acct] + (f.type==="in" ? f.amount : -f.amount);
    if(after < 0){
      showMsg("ä½™é¢ä¸è¶³ï¼Œä¸èƒ½æ”¯å‡ºè¿™ç¬”é‡‘é¢ã€‚", "bad");
      return;
    }

    if(editingId){
      const idx = data.tx.findIndex(x=>x.id===editingId);
      if(idx === -1){
        showMsg("æ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„è®°å½•ï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰", "bad");
        editingId = null;
        btnSaveEl.textContent = "ä¿å­˜è¿™ä¸€ç¬”";
        return;
      }

      // Temporarily remove old record to re-check balance correctly
      const old = data.tx[idx];
      const txWithoutOld = data.tx.filter(x=>x.id!==editingId);
      const bal2 = calcBalances(txWithoutOld);
      const after2 = bal2[f.acct] + (f.type==="in" ? f.amount : -f.amount);
      if(after2 < 0){
        showMsg("ä¿®æ”¹åä¼šå¯¼è‡´ä½™é¢ä¸è¶³ï¼Œè¯·è°ƒæ•´é‡‘é¢æˆ–è´¦æˆ·ã€‚", "bad");
        return;
      }

      data.tx[idx] = {
        ...old,
        acct: f.acct,
        type: f.type,
        amount: Math.round(f.amount),
        date: f.date,
        cat: f.cat,
        note: f.note
      };
      persist(data);
      showMsg("å·²ä¿å­˜ä¿®æ”¹ âœ…", "good");
      editingId = null;
      btnSaveEl.textContent = "ä¿å­˜è¿™ä¸€ç¬”";
      render();
      return;
    }

    // new record
    const now = new Date();
    const id = "tx_" + now.getTime() + "_" + Math.random().toString(16).slice(2);
    data.tx.push({
      id,
      createdAt: now.toISOString(),
      acct: f.acct,
      type: f.type,
      amount: Math.round(f.amount),
      date: f.date,
      cat: f.cat,
      note: f.note
    });
    persist(data);
    showMsg("å·²æ·»åŠ ä¸€ç¬” âœ…", "good");
    amtEl.value = "";
    noteEl.value = "";
    render();
  }

  function startEdit(id){
    const data = load();
    const t = data.tx.find(x=>x.id===id);
    if(!t) return;

    editingId = id;
    acctEl.value = t.acct;
    typeEl.value = t.type;
    amtEl.value = t.amount;
    dateEl.value = t.date || todayISO();
    catEl.value = t.cat || "";
    noteEl.value = t.note || "";
    btnSaveEl.textContent = "ä¿å­˜ä¿®æ”¹";
    showMsg("æ­£åœ¨ç¼–è¾‘ï¼šæ”¹å®Œç‚¹â€œä¿å­˜ä¿®æ”¹â€", "");
    window.scrollTo({top: 0, behavior: "smooth"});
  }

  function deleteTx(id){
    const data = load();
    const idx = data.tx.findIndex(x=>x.id===id);
    if(idx === -1) return;
    if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;

    data.tx.splice(idx,1);
    persist(data);
    if(editingId === id){
      editingId = null;
      btnSaveEl.textContent = "ä¿å­˜è¿™ä¸€ç¬”";
    }
    showMsg("å·²åˆ é™¤ ğŸ—‘ï¸", "");
    render();
  }

  function exportCSV(){
    const data = load();
    const rows = [["date","account","type","amount_jpy","category","note"]];
    data.tx.forEach(t=>{
      rows.push([
        t.date,
        acctName(t.acct),
        (t.type==="in" ? "in" : "out"),
        t.amount,
        catName(t.cat),
        (t.note||"").replaceAll('"','""')
      ]);
    });
    const csv = rows.map(r=>r.map(x=>`"${String(x)}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "yoyi_money_tracker.csv";
    a.click();
    URL.revokeObjectURL(url);
    showMsg("å·²å¯¼å‡º CSV ğŸ“„", "good");
  }

  function resetAll(){
    if(!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
    localStorage.removeItem(KEY);
    clearForm();
    showMsg("å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®", "");
    render();
  }

  // init
  dateEl.value = todayISO();
  render();
</script>
</body>
</html>
